<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeric POS - Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{font-family:'Poppins',sans-serif;background:#0a1a22;color:#fff;margin:0;padding:0;}
header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:rgba(0,255,204,0.05);}
header h2{color:#00ffcc;}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin:2px;}
.primary{background:#00ffcc;color:#000;}
.danger{background:#ff4d4d;color:#fff;}
.layout{display:flex;flex-wrap:wrap;gap:20px;padding:20px;}
.panel{background:rgba(255,255,255,0.05);border-radius:10px;padding:16px;flex:1;min-width:300px;max-height:600px;overflow:auto;}
input,select,textarea{width:100%;padding:8px;margin:6px 0;border-radius:6px;border:1px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);color:#fff;}
.item{padding:6px;margin:6px 0;border-radius:6px;border:1px solid rgba(255,255,255,0.05);background:rgba(255,255,255,0.03);}
img{max-width:100px;border-radius:6px;}
.cart-item{display:flex;justify-content:space-between;align-items:center;}
.progress-bar{display:flex;justify-content:space-between;margin-top:6px;}
.progress-bar div{width:30%;text-align:center;padding:4px;border-radius:6px;}
</style>
</head>
<body>
<header>
<h2>Jeric POS - Shop</h2>
<div>
  <button id="logoutBtn" class="danger">Logout</button>
  <button id="viewCartBtn" class="primary">View Cart</button>
</div>
</header>

<div class="layout">
  <!-- Products Panel -->
  <div class="panel" style="flex:2;">
    <h3>Products</h3>
    <div id="productsList">Loading...</div>
  </div>

  <!-- Cart / Order Tracking Panel -->
  <div class="panel" style="flex:1;">
    <h3>My Cart</h3>
    <div id="cartList">Your cart is empty.</div>
    <h3>Order Tracking</h3>
    <div id="ordersTracking">Loading...</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyDd_04phC5KuoSnpC-mg6ASGFlRVX_d4Dk",
  authDomain: "jeric-pos.firebaseapp.com",
  projectId: "jeric-pos",
  storageBucket: "jeric-pos.appspot.com",
  messagingSenderId: "294868456105",
  appId: "1:294868456105:web:03c3e18a7037afbad80fb8"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let cart=[];

// Auth
auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  currentUser=user;
  loadProducts();
  loadCart();
  trackOrders();
});

// Logout
document.getElementById("logoutBtn").onclick=()=>auth.signOut().then(()=>location.href="index.html");

// --- Load Products ---
async function loadProducts(){
  const list=document.getElementById("productsList");
  list.innerHTML="Loading...";
  db.collection("products").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    list.innerHTML="";
    snapshot.forEach(doc=>{
      const p=doc.data();
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`<strong>${p.name}</strong> - ₱${p.price} - Stock:${p.stock}<br>
      <img src="${p.image||'https://via.placeholder.com/100'}">
      <button class="primary" onclick="addToCart('${doc.id}','${p.name}',${p.price},${p.stock})">Add to Cart</button>`;
      list.appendChild(div);
    });
  });
}

// --- Cart ---
function addToCart(id,name,price,stock){
  const existing=cart.find(c=>c.id===id);
  if(existing){
    if(existing.qty>=stock) return alert("No more stock available");
    existing.qty++;
  } else cart.push({id,name,price,qty:1,stock});
  loadCart();
}

function loadCart(){
  const list=document.getElementById("cartList");
  if(cart.length===0) return list.innerHTML="Your cart is empty.";
  list.innerHTML="";
  cart.forEach(c=>{
    const div=document.createElement("div");
    div.className="cart-item";
    div.innerHTML=`${c.name} x${c.qty} - ₱${c.price*c.qty} 
    <button class="danger" onclick="removeFromCart('${c.id}')">Remove</button>`;
    list.appendChild(div);
  });
  const checkoutBtn=document.createElement("button");
  checkoutBtn.className="primary";
  checkoutBtn.textContent="Checkout";
  checkoutBtn.onclick=checkout;
  list.appendChild(checkoutBtn);
}

function removeFromCart(id){
  cart=cart.filter(c=>c.id!==id);
  loadCart();
}

// --- Checkout ---
async function checkout(){
  if(cart.length===0) return alert("Cart is empty");
  const address=prompt("Enter your delivery address:");
  if(!address) return alert("Delivery address required");
  const payment=prompt("Payment method (Cash / GCash / Card):");
  if(!payment) return alert("Payment option required");
  
  const total=cart.reduce((sum,c)=>sum+c.price*c.qty,0);
  await db.collection("orders").add({
    userId:currentUser.uid,
    userEmail:currentUser.email,
    items:cart,
    total,
    address,
    payment,
    status:"pending",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  alert("✅ Order placed successfully!");
  cart=[];
  loadCart();
}

// --- Order Tracking ---
function trackOrders(){
  const container=document.getElementById("ordersTracking");
  db.collection("orders").where("userId","==",currentUser.uid).orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      container.innerHTML="";
      if(snapshot.empty) return container.innerHTML="No orders yet.";
      snapshot.forEach(doc=>{
        const o=doc.data();
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`<strong>Order #${doc.id}</strong> - Total: ₱${o.total}`;
        
        const bar=document.createElement("div");
        bar.className="progress-bar";
        const stages=["pending","processing","completed"];
        const colors={pending:"#ff4d4d",processing:"#ffcc00",completed:"#00ffcc"};
        stages.forEach((stage,index)=>{
          const step=document.createElement("div");
          step.textContent=stage.toUpperCase();
          step.style.backgroundColor=stages.indexOf(o.status)>=index ? colors[stage]:"rgba(255,255,255,0.1)";
          bar.appendChild(step);
        });
        div.appendChild(bar);

        const addr=document.createElement("small");
        addr.style.display="block";
        addr.textContent=`Delivery: ${o.address} | Payment: ${o.payment} | Status: ${o.status.toUpperCase()}`;
        div.appendChild(addr);

        container.appendChild(div);
      });
    });
}
</script>
</body>
</html>
