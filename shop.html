<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeric POS - Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; background:#0a1a22; color:#fff; margin:0; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:rgba(0,255,204,0.05); border-bottom:1px solid rgba(0,255,204,0.2);}
header h2 { color:#00ffcc; margin:0; }
button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin:2px; }
.primary { background:#00ffcc; color:#000; }
.danger { background:#ff4d4d; color:#fff; }
.container { display:flex; flex-wrap:wrap; gap:20px; padding:20px; }
.product { background:rgba(255,255,255,0.05); border-radius:10px; padding:10px; width:200px; text-align:center; }
.product img { max-width:100%; border-radius:6px; }
.cart { position:fixed; top:20px; right:20px; background:rgba(0,255,204,0.1); padding:10px; border-radius:10px; width:250px; max-height:400px; overflow:auto; }
.cart h3 { color:#00ffcc; margin-top:0; }
.cart-item { border-bottom:1px solid rgba(255,255,255,0.1); padding:4px; }
input, select { width:100%; padding:6px; margin:4px 0; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:#fff; }
</style>
</head>
<body>
<header>
  <h2>Shop</h2>
  <div>
    <button id="logoutBtn" class="danger">Logout</button>
  </div>
</header>

<div class="container" id="productsContainer">Loading products...</div>

<div class="cart">
  <h3>My Cart</h3>
  <div id="cartItems"></div>
  <input type="text" id="address" placeholder="Delivery Address">
  <select id="payment">
    <option value="">Select Payment</option>
    <option value="cash">Cash on Delivery</option>
    <option value="gcash">Gcash</option>
  </select>
  <button id="checkoutBtn" class="primary">Place Order</button>
  <h3>My Orders</h3>
  <div id="myOrders">Loading...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
// Firebase setup
const firebaseConfig = {
  apiKey: "AIzaSyDd_04phC5KuoSnpC-mg6ASGFlRVX_d4Dk",
  authDomain: "jeric-pos.firebaseapp.com",
  projectId: "jeric-pos",
  storageBucket: "jeric-pos.appspot.com",
  messagingSenderId: "294868456105",
  appId: "1:294868456105:web:03c3e18a7037afbad80fb8"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

let currentUser=null;
let cart=[];

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  currentUser=user;
  loadProducts();
  loadOrders();
});

document.getElementById("logoutBtn").onclick = ()=>auth.signOut().then(()=>location.href="index.html");

async function loadProducts(){
  const container=document.getElementById("productsContainer");
  container.innerHTML="Loading products...";
  const snap=await db.collection("products").orderBy("name").get();
  container.innerHTML="";
  snap.forEach(doc=>{
    const p=doc.data();
    const div=document.createElement("div");
    div.className="product";
    div.innerHTML=`
      <img src="${p.image||'https://via.placeholder.com/100'}" alt="${p.name}">
      <strong>${p.name}</strong><br>₱${p.price}<br>Stock: ${p.stock}
      <button class="primary" ${p.stock===0?'disabled':''} onclick="addToCart('${doc.id}','${p.name}',${p.price},${p.stock})">Add to Cart</button>
    `;
    container.appendChild(div);
  });
}

function addToCart(id,name,price,stock){
  const existing=cart.find(c=>c.id===id);
  if(existing){
    if(existing.qty<stock) existing.qty++;
    else return alert("Not enough stock");
  }else cart.push({id,name,price,qty:1,stock});
  renderCart();
}

function renderCart(){
  const div=document.getElementById("cartItems");
  div.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    total+=item.price*item.qty;
    const el=document.createElement("div");
    el.className="cart-item";
    el.innerHTML=`${item.name} x ${item.qty} = ₱${item.price*item.qty} <button onclick="removeFromCart('${item.id}')">Remove</button>`;
    div.appendChild(el);
  });
  const totalEl=document.createElement("div");
  totalEl.innerHTML=`<strong>Total: ₱${total}</strong>`;
  div.appendChild(totalEl);
}

function removeFromCart(id){
  cart=cart.filter(c=>c.id!==id);
  renderCart();
}

// Place order
document.getElementById("checkoutBtn").onclick=async ()=>{
  const address=document.getElementById("address").value.trim();
  const payment=document.getElementById("payment").value;
  if(cart.length===0 || !address || !payment) return alert("Fill all fields and add items to cart");

  const total=cart.reduce((a,b)=>a+b.price*b.qty,0);
  await db.collection("orders").add({
    userId: currentUser.uid,
    userEmail: currentUser.email,
    items: cart,
    total,
    address,
    payment,
    status:"pending",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  cart=[]; renderCart(); document.getElementById("address").value=""; document.getElementById("payment").value="";
  alert("Order placed!");
  loadOrders();
}

// Load customer orders
function loadOrders(){
  const div=document.getElementById("myOrders");
  db.collection("orders").where("userId","==",currentUser.uid).orderBy("createdAt","desc").onSnapshot(snapshot=>{
    div.innerHTML="";
    if(snapshot.empty){ div.innerHTML="No orders yet"; return; }
    snapshot.forEach(doc=>{
      const o=doc.data();
      const d=document.createElement("div");
      d.style.borderBottom="1px solid rgba(255,255,255,0.1)";
      d.style.padding="4px";
      d.innerHTML=`Order ID: ${doc.id}<br>
        Items: ${o.items.map(i=>i.name+" x"+i.qty).join(", ")}<br>
        Total: ₱${o.total}<br>
        Status: <strong>${o.status}</strong><br>
        Address: ${o.address}<br>
        Payment: ${o.payment}`;
      div.appendChild(d);
    });
  });
}
</script>
</body>
</html>
