<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeric POS - Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; background:#0a1a22; color:#fff; margin:0; }
header { display:flex; justify-content:space-between; align-items:center; padding:16px; background:rgba(0,255,204,0.05); border-bottom:1px solid rgba(0,255,204,0.2);}
header h2 { color:#00ffcc; margin:0; }
button { padding:6px 10px; border:none; border-radius:6px; cursor:pointer; font-weight:600; margin:2px; }
.primary { background:#00ffcc; color:#000; }
.danger { background:#ff4d4d; color:#fff; }
.layout { display:flex; flex-wrap:wrap; gap:20px; padding:20px; }
.panel { background:rgba(255,255,255,0.05); border:1px solid rgba(0,255,204,0.15); border-radius:10px; padding:16px; flex:1; min-width:300px; }
h3 { color:#00ffcc; margin-top:0; }
.item { padding:8px; margin-top:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.05); background:rgba(255,255,255,0.03); }
img { max-width:100px; border-radius:6px; }
input, select { width:100%; padding:8px; margin:4px 0; border-radius:6px; border:1px solid rgba(255,255,255,0.15); background:rgba(255,255,255,0.05); color:#fff; }
.cart-item { display:flex; justify-content:space-between; margin-bottom:4px; }
.receipt { background:rgba(0,255,204,0.1); color:#000; padding:8px; border-radius:6px; margin-top:10px; }
</style>
</head>
<body>
<header>
  <h2>Shop</h2>
  <div>
    <button id="logoutBtn" class="danger">Logout</button>
    <button id="goCartBtn" class="primary">View Cart</button>
  </div>
</header>

<div class="layout">
  <div class="panel" style="flex:2;">
    <h3>Products</h3>
    <div id="productsList">Loading...</div>
  </div>

  <div class="panel" style="flex:1;">
    <h3>Cart</h3>
    <div id="cartList">Your cart is empty.</div>
    <input id="customerAddress" placeholder="Delivery Address">
    <select id="paymentMethod">
      <option value="Cash">Cash</option>
      <option value="Gcash">Gcash</option>
      <option value="Credit Card">Credit Card</option>
    </select>
    <button id="placeOrderBtn" class="primary">Place Order</button>

    <h3>My Orders</h3>
    <div id="myOrders">Loading...</div>

    <h3>Receipt</h3>
    <div id="receipt">No orders yet.</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDd_04phC5KuoSnpC-mg6ASGFlRVX_d4Dk",
  authDomain: "jeric-pos.firebaseapp.com",
  projectId: "jeric-pos",
  storageBucket: "jeric-pos.appspot.com",
  messagingSenderId: "294868456105",
  appId: "1:294868456105:web:03c3e18a7037afbad80fb8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser=null;
let cart=[];

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="index.html";
  currentUser=user;
  loadProducts();
  loadMyOrders();
});

// Logout
document.getElementById("logoutBtn").onclick = () => auth.signOut().then(()=>location.href="index.html");

// Load products
async function loadProducts(){
  const list=document.getElementById("productsList");
  const snap=await db.collection("products").where("stock",">",0).get();
  list.innerHTML="";
  snap.forEach(doc=>{
    const p=doc.data();
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`<strong>${p.name}</strong> - ₱${p.price} - Stock: ${p.stock}<br>
      <img src="${p.image||'https://via.placeholder.com/100'}">
      <br><button class="primary" onclick="addToCart('${doc.id}','${p.name}',${p.price})">Add to Cart</button>`;
    list.appendChild(div);
  });
}

// Cart functions
function addToCart(id,name,price){
  cart.push({id,name,price});
  renderCart();
}

function renderCart(){
  const cartDiv=document.getElementById("cartList");
  if(cart.length===0){ cartDiv.innerHTML="Your cart is empty."; return; }
  cartDiv.innerHTML="";
  cart.forEach((i,index)=>{
    const div=document.createElement("div");
    div.className="cart-item";
    div.innerHTML=`${i.name} - ₱${i.price} <button onclick="removeCart(${index})" class="danger">X</button>`;
    cartDiv.appendChild(div);
  });
}

function removeCart(index){
  cart.splice(index,1);
  renderCart();
}

// Place order
document.getElementById("placeOrderBtn").onclick = async () => {
  const address = document.getElementById("customerAddress").value.trim();
  const payment = document.getElementById("paymentMethod").value;
  if(cart.length===0){ alert("Cart is empty"); return; }
  if(!address){ alert("Enter delivery address"); return; }

  const total = cart.reduce((a,b)=>a+b.price,0);

  try{
    const orderRef = await db.collection("orders").add({
      userId: currentUser.uid,
      userEmail: currentUser.email,
      items: cart,
      total,
      address,
      payment,
      status:"pending",
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });

    // Update stock
    const batch=db.batch();
    cart.forEach(item=>{
      const prodRef=db.collection("products").doc(item.id);
      batch.update(prodRef,{ stock: firebase.firestore.FieldValue.increment(-1) });
    });
    await batch.commit();

    // Generate receipt
    let receiptHTML=`<div class="receipt"><strong>Receipt</strong><br>Order ID: ${orderRef.id}<br>`;
    cart.forEach(i=>receiptHTML+=`${i.name} - ₱${i.price}<br>`);
    receiptHTML+=`<strong>Total: ₱${total}</strong><br>Address: ${address}<br>Payment: ${payment}</div>`;
    document.getElementById("receipt").innerHTML=receiptHTML;

    cart=[]; renderCart(); document.getElementById("customerAddress").value="";
    loadMyOrders();

  }catch(e){
    console.error(e);
    alert("Error placing order.");
  }
}

// Load my orders
function loadMyOrders(){
  const myOrdersDiv=document.getElementById("myOrders");
  db.collection("orders").where("userId","==",currentUser.uid).orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      myOrdersDiv.innerHTML="";
      snapshot.forEach(doc=>{
        const o=doc.data();
        const date=o.createdAt ? o.createdAt.toDate().toLocaleString() : "Unknown";
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`<strong>Order ID:</strong> ${doc.id}<br>
          Items: ${o.items.map(i=>i.name).join(", ")}<br>
          Total: ₱${o.total}<br>
          Status: <em>${o.status}</em><br>
          Address: ${o.address}<br>
          Payment: ${o.payment}<br>
          <small>${date}</small>`;
        myOrdersDiv.appendChild(div);
      });
    });
}
</script>
</body>
</html>
